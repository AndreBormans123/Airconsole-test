worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  server_tokens off;

  server {
    listen 8080;                 # was 80
    server_name _;

    root  /app;                  # was /usr/share/nginx/html
    index screen.html;           # was index.html

    # Health endpoint
    location = /health {
      add_header Content-Type text/plain;
      return 200 'ok';
    }

    # Compression (serve .gz if aanwezig)
    gzip on;
    gzip_static on;
    gzip_min_length 1024;
    gzip_types application/javascript text/javascript text/plain text/html application/wasm application/octet-stream;

    # Cross-origin isolation (WebGL/SharedArrayBuffer)
    add_header Cross-Origin-Embedder-Policy require-corp always;
    add_header Cross-Origin-Opener-Policy   same-origin  always;

    # Resource policy: laat assets cross-origin indien nodig
    add_header Cross-Origin-Resource-Policy cross-origin always;
    add_header Access-Control-Allow-Origin "*" always;

    # Mime types (Unity)
    types {
      application/wasm wasm;
      application/octet-stream unityweb;
    }

    # Default: GEEN SPA fallback; respecteer echte bestanden
    location / {
      try_files $uri $uri/ =404;   # was fallback naar /index.html
      add_header Cache-Control "no-cache";
    }

    # WASM (en .wasm.gz)
    location ~* \.wasm$ {
      add_header Content-Type "application/wasm";
      add_header Vary "Accept-Encoding";
      add_header Cache-Control "public, max-age=31536000, immutable";
      try_files $uri $uri.gz =404;
    }
    location ~ \.wasm\.gz$ {
      add_header Content-Encoding gzip;
      add_header Content-Type "application/wasm";
      add_header Vary "Accept-Encoding";
      add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Unity data/mem/unityweb
    location ~* \.(data|mem|unityweb)$ {
      add_header Content-Type "application/octet-stream";
      add_header Cache-Control "public, max-age=31536000, immutable";
      try_files $uri $uri.gz =404;
    }

    # Statics (js/css/html/svg/json) â€“ serve gz if available
    location ~* \.(js|css|html|svg|json)$ {
      add_header Cache-Control "public, max-age=31536000, immutable";
      try_files $uri $uri.gz $uri =404;
    }

    # deny dotfiles
    location ~ /\. { deny all; }
  }
}
